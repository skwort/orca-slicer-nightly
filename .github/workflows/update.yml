name: Update Nightly

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install Nix
        uses: cachix/install-nix-action@v31
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}

      - name: Check for updates
        id: check
        run: |
          if ./scripts/update-version.sh --check; then
            echo "update_needed=false" >> $GITHUB_OUTPUT
          else
            source <(./scripts/update-version.sh --check 2>&1 | grep -E '^(CURRENT|LATEST)=' || true)
            CURRENT=$(jq -r .version nightly.json)
            LATEST_REV=$(git ls-remote https://github.com/OrcaSlicer/OrcaSlicer.git refs/tags/nightly-builds | cut -f1)
            SHORT_REV=$(echo "$LATEST_REV" | cut -c1-7)

            echo "current=$CURRENT" >> $GITHUB_OUTPUT
            echo "latest=nightly-$(date -u +%Y-%m-%d)-$SHORT_REV" >> $GITHUB_OUTPUT
            echo "update_needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Run update script
        if: steps.check.outputs.update_needed == 'true'
        run: ./scripts/update-version.sh

      - name: Create Pull Request
        if: steps.check.outputs.update_needed == 'true'
        id: create-pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update to ${{ steps.check.outputs.latest }}"
          title: "chore: update to ${{ steps.check.outputs.latest }}"
          body: |
            ## Automated OrcaSlicer Nightly Update

            This PR updates OrcaSlicer nightly from `${{ steps.check.outputs.current }}` to `${{ steps.check.outputs.latest }}`.

            ### Changes
            - Updated `version` in `nightly.json`
            - Updated `rev` (commit SHA) in `nightly.json`
            - Updated `hash` in `nightly.json`
            - Updated `flake.lock`

            ### Verification
            - ✅ Hash automatically calculated via `nix-prefetch-git`
            - ✅ Flake evaluation verified

            ---

            To test this update locally:
            ```bash
            nix build
            ./result/bin/orca-slicer --version
            ```

            This PR was automatically generated by the update workflow.
          branch: update-nightly-${{ steps.check.outputs.latest }}
          delete-branch: true
          labels: |
            dependencies
            automated

      - name: Summary
        if: always()
        run: |
          echo "## Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check.outputs.update_needed }}" == "true" ]; then
            echo "- **Current Version:** ${{ steps.check.outputs.current }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Latest Version:** ${{ steps.check.outputs.latest }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ steps.create-pr.outputs.pull-request-number }}" ]; then
              echo "✅ Pull request #${{ steps.create-pr.outputs.pull-request-number }} created!" >> $GITHUB_STEP_SUMMARY
            fi
          else
            CURRENT=$(jq -r .version nightly.json)
            echo "- **Current Version:** $CURRENT" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ Already up to date!" >> $GITHUB_STEP_SUMMARY
          fi
